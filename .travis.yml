sudo: "required"

services:
    - "docker"

language: "python"

python:
    - "3.5"

env:
  # Travis has a maximum test run time of 50 minutes.
  # In order to avoid this and to see failures faster, we run multiple builds
  # per commit.
  # We run almost one builder per test.
  matrix:
      - "TEST_PATTERN=tests/test_enterprise.py::TestEnterpriseIntegrationTests::test_run_pytest"
      - "TEST_PATTERN=tests/test_enterprise.py::TestWaitForDCOS::test_auth_with_cli"
      - "TEST_PATTERN=tests/test_node.py::TestNode::test_run_as_root"
      - "TEST_PATTERN=tests/test_node.py::TestNode::test_popen_as_root"
      - "TEST_PATTERN=tests/test_harness.py::TestIntegrationTests::test_run_pytest"
      - "TEST_PATTERN=tests/test_harness.py::TestExtendConfig::test_extend_config"
      - "TEST_PATTERN=tests/test_harness.py::TestExtendConfig::test_default_config"
      - "TEST_PATTERN=tests/test_harness.py::TestClusterSize::test_default"
      - "TEST_PATTERN=tests/test_harness.py::TestClusterSize::test_custom"
      - "TEST_PATTERN=tests/test_harness.py::TestClusterLogging::test_live_logging"
      - "TEST_PATTERN=tests/test_harness.py::TestClusterLogging::test_no_live_logging"
      - "TEST_PATTERN=tests/test_harness.py::TestMultipleClusters::test_two_clusters"
      - "TEST_PATTERN=tests/test_harness.py::TestDestroyOnError::test_default_exception_raised"
      - "TEST_PATTERN=tests/test_harness.py::TestDestroyOnError::test_set_false_exception_raised"
      - "TEST_PATTERN=tests/test_harness.py::TestDestroyOnSuccess::test_default"
      - "TEST_PATTERN=tests/test_harness.py::TestDestroyOnSuccess::test_false"
      - "TEST_PATTERN=tests/test_harness.py::TestCopyFiles::test_copy_files"
      - "TEST_PATTERN=tests/backends/test_dcos_docker.py::TestBadParameters::test_no_installer_file"
      - "TEST_PATTERN=tests/backends/test_existing_cluster.py::TestExistingCluster::test_existing_cluster"
      # This test class uses one scoped cluster so we run it on one builder.
      - "TEST_PATTERN=tests/backends/test_existing_cluster.py::TestBadParameters"
  global:
    # The encrypted URL for a DC/OS Enterprise artifact.
    # Generate this by running:
    #     travis encrypt --repo mesosphere/dcos-e2e EE_ARTIFACT_URL="$EE_ARTIFACT_URL"
    secure: "GVvmpWjOdlpZnr0WDPSZEpMXfoDTTU3L0VHaB9cToPrRqx7fn7vT8DhDQKtvprow/SBzR6MzIxsYVSWpRIhglqaXxD057rJRwnSlIxhahI6z6+n9v4NoFAeTiJPIpJjAjKxyGe+zROMI0IvjjvWkYtTxaiZ2dNaT/Zx66udwnJMQ1fHgT/QgBMvPU0DXpRs2ClLI+o80UlX1FdtyCpHA0wRox56c1TCQamX2wXyCUat+sW4ehb6cim8N72Q7s2ypXxaT8prSkD3rJHd6FqhztDYJFwmtJTG63egV0Ux3j9DGtF+ICklgPzk1wgA9UQSTJEDDgN6j2E9ZvFWunWb3i9dkKpkbrUf7Ti8MZjORnKvWSmlrcUTWJbqx7AeWoG7xR0Eo3KzYRlcLWqSY0nWgNr286k2tH4hzGBxBOHAsik+y1JtkEUohs5memhI0J9aSH7mfLaNEwIozPDcqyV51Nu9i0+wFry16E3e07SnIvHize0jAFQnEa4TkP+z8Knlh76tY3ISBERtvAbtHy39PcKM9F56w16joJLdcmE0T0a3QqjhZ03a3mgFsGQN0n6klZ3mCxYHzUBpDrBaPwJ7EeLnRGyPQyRi5OaSk1j0Psv2LslByeK1z5PpxfJKx60GHO2dUUvk1nMPTgHUMfkVQ7IDNzged7OJYCYjecRNvxKI="

before_install:
    - "travis_retry pip install --upgrade pip setuptools codecov"
    - "travis_retry sudo apt-get update"
      # Ideally we would use `addons.apt.packages` for enchant but this is not
      # supported by the linter.
    - "travis_retry sudo apt-get install docker-ce enchant"
    - "travis_retry npm -g install npm@latest"

install:
    - "travis_retry pip install --upgrade --editable .[dev]"
    - "travis_retry npm install"

cache: "pip"

before_script:
    - "make clean"
    - "make lint"
    - 'travis_retry make EE_ARTIFACT_URL=$EE_ARTIFACT_URL download-artifacts'

script:
    - 'pytest -vvv -s "$TEST_PATTERN" --cov=src --cov=tests'

after_success:
    - "codecov"
